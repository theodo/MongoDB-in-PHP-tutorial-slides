<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">

        <title>MongoDB in PHP &amp; Doctrine ODM</title>

        <meta name="description" content="How to start with MongoDB in PHP and go further with the Doctrine ODM abstraction layer.">
        <meta name="author" content="Fabrice A. Bernhard">

        <link href='http://fonts.googleapis.com/css?family=Metrophobic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>

        <link rel="stylesheet" href="css/reset.css">
        <link rel="stylesheet" href="css/main.css">

        <link rel="stylesheet" href="lib/github.css">
    </head>

    <body>

        <div id="reveal">

            <!-- Any section element inside of this container is displayed as a slide -->
            <div class="slides">
                <section>
                    <h1>MongoDB in PHP</h1>
                    <h3 class="inverted">How to start with MongoDB in PHP...<br/ ><br/ >...and go further with Doctrine ODM</h3>
                    <script>
                        // Delicously hacky. Look away.
                        if( navigator.userAgent.match( /(iPhone|iPad|iPod|Android)/i ) )
                        document.write( '<p style="color: rgba(0,0,0,0.3); text-shadow: none;">('+'Tap to navigate'+')</p>' );
                    </script>
                </section>

                <section>

                    <h2>Purpose</h2>


                    <p>
                        This is an interactive guide through the first steps of using MongoDB in PHP.
                    </p>
                    <br />
                    <p>
                        The presentation is largely based on Jonathan Wage's <a href="http://www.slideshare.net/jwage/doctrine-mongodb-object-document-mapper">Doctrine MongoDB ODM</a> presentation
http://www.slideshare.net/kriswallsmith/mongod-pdxphp
                    </p>

                    <br />
                    <p>
                        This guide tries to address both Ubuntu and MacOS X users with PHP5 already installed
                    </p>

                </section>


                <section>
                    <section>
                        <h2>Starting on Ubuntu</h2>
                        <h4 class="inverted">Installing MongoDB for PHP</h4>

                        <pre><code>
  sudo apt-get install mongodb
  sudo apt-get install php-pear php5-dev
  sudo pecl install mongo
                        </code></pre>

                    </section>

                    <section>
                        <h2>Configuring on Ubuntu</h2>
                        <h4 class="inverted">Installing MongoDB for PHP</h4>

                        <pre><code>
  #configuration file /etc/php5/conf.d/mongo.ini

  extension=mongo.so
                        </code></pre>

                    </section>

                    <section>
                        <h2>Starting on MacOS X</h2>
                        <h4 class="inverted">Installing MongoDB for PHP</h4>

                        <pre><code>
  sudo port install php5-mongo

  sudo mkdir /opt/local/var/db/mongodb_data
  sudo mkdir /opt/local/var/log/mongodb
  sudo touch /opt/local/var/log/mongodb/mongodb.log
  sudo mkdir /opt/local/etc/mongodb/
                        </code></pre>

                    </section>

                    <section>
                        <h2>Configuring on MacOS X</h2>
                        <h4 class="inverted">Installing MongoDB for PHP</h4>

                        <pre><code>
  #configuration file /opt/local/etc/mongodb/mongod.conf

  # Store data alongside MongoDB instead of the default, /data/db/
  dbpath = /opt/local/var/db/mongodb_data
  # Only accept local connections
  bind_ip = 127.0.0.1
  # Running as daemon
  fork = true
  # Take log
  logpath = /opt/local/var/log/mongodb/mongodb.log
  logappend = true
                        </code></pre>

                    </section>

                    <section>
                        <h2>Launching on MacOS X</h2>
                        <h4 class="inverted">Installing MongoDB for PHP</h4>

                        <pre><code>
  sudo mongod -f /opt/local/etc/mongodb/mongod.conf
                        </code></pre>

                    </section>
                </section>




                <section>
                    <section>
                        <h2>Connecting</h2>
                        <h4 class="inverted">First steps in PHP</h4>

                        <pre><code class="php">
  $mongo = new Mongo('mongodb://localhost');
                        </code></pre>
                    </section>

                    <section>
                        <h2>Selecting a database</h2>
                        <h4 class="inverted">First steps in PHP</h4>

                        <pre><code class="php">
  $mongo = new Mongo('mongodb://localhost');
  $db = $mongo->selectDB('dbname');
                        </code></pre>
                    </section>

                    <section>
                        <h2>Selecting a collection</h2>
                        <h4 class="inverted">First steps in PHP</h4>

                        <pre><code class="php">
  $coll = $db->selectCollection('measurements');
                        </code></pre>
                    </section>


                    <section>
                        <h2>Inserting a document</h2>
                        <h4 class="inverted">First steps in PHP</h4>

                        <pre><code class="php">
  $datetime = new MongoDate($datetime);
  $measurement = array(
    'captor1' => 981,
    'captor2' => 954,
    'datetime' => $datetime
  );
  $coll->insert($measurement);

  var_dump($measurement);
  echo $measurement['_id'] . "\n";
                        </code></pre>
                    </section>

                    <section>
                        <h2>Updating a document</h2>
                        <h4 class="inverted">First steps in PHP</h4>

                        <pre><code class="php">
  $measurement = $coll->findOne(
    array(
      'datetime' => $datetime
    )
  );
  $measurement['captor1'] = 982;
  $measurement['captor2'] = 955;
  $coll->save($measurement);

  var_dump($measurement);
  echo $measurement['_id'] . "\n";
                        </code></pre>
                    </section>

                    <section>
                        <h2>Atomic update</h2>
                        <h4 class="inverted">First steps in PHP</h4>

                        <pre><code class="php">
  $coll->update(
    array('datetime' => $datetime),
    array(
      '$set' => array(
        'captor1' => 983,
        'captor2' => 956
      )
    )
  );
  $measurement = $coll->findOne(
    array('datetime' => $datetime)
  );
  var_dump($measurement);
                        </code></pre>
                    </section>

                    <section>
                        <h2>Removing a document</h2>
                        <h4 class="inverted">First steps in PHP</h4>

                        <pre><code class="php">
  $coll->remove(
    array('datetime' => $datetime)
  );

  $measurement = $coll->findOne(
    array('datetime' => $datetime)
  );
  var_dump($measurement); // NULL
                        </code></pre>
                    </section>


                </section>




                <section>

                    <h2>Doctrine MongoDB ODM</h2>
                    <h4 class="inverted">An abstraction layer for your documents</h4>

                    <ul>
                    	<li>Manages the persistent state of PHP objects</li>
                    	<li>Implements <a href="http://martinfowler.com/eaaCatalog/unitOfWork.html">UnitOfWork</a> for change tracking</li>
                    	<li>Handles references between documents (lazily)</li>
                    	<li>Provides lifecycle event listeners (useful for migrations)</li>
                    </ul>
                </section>

                <section>
                  <section>

                    <h2>Install Doctrine MongoDB ODM</h2>
                    <h4 class="inverted">Starting with Doctrine MongoDB ODM</h4>

                        <pre><code>
  wget http://getcomposer.org/composer.phar

  echo '{"require": {"doctrine/mongodb-odm": "*" }}'
    > composer.json

  php composer.phar install
                        </code></pre>
                  </section>

                  <section>

                    <h2>Bootstrap Doctrine MongoDB ODM 1/2</h2>
                    <h4 class="inverted">Starting with Doctrine MongoDB ODM</h4>

                        <pre><code class="php" style="font-size:24px;">
require "vendor/.composer/autoload.php";

use Doctrine\Common\ClassLoader,
    Doctrine\ODM\MongoDB\Configuration,
    Doctrine\Common\Annotations\AnnotationReader,
    Doctrine\ODM\MongoDB\Mapping\Driver\AnnotationDriver,
    Doctrine\ODM\MongoDB\DocumentManager,
    Doctrine\MongoDB\Connection;

$config = new Configuration();
$config->setProxyDir(__DIR__ . '/cache');
$config->setProxyNamespace('Proxies');
                        </code></pre>
                  </section>

                  <section>

                    <h2>Bootstrap Doctrine MongoDB ODM 2/2</h2>
                    <h4 class="inverted">Starting with Doctrine MongoDB ODM</h4>

                        <pre><code class="php" style="font-size:24px;">
$config->setHydratorDir(__DIR__ . '/cache');
$config->setHydratorNamespace('Hydrators');

$annotationDriver = $config->newDefaultAnnotationDriver(
  array(__DIR__ . '/Documents')
);
$config->setMetadataDriverImpl($annotationDriver);
AnnotationDriver::registerAnnotationClasses();

$dm = DocumentManager::create(new Connection(), $config);
                        </code></pre>
                  </section>
                </section>
                <section>
                  <section>

                    <h2>Doctrine object</h2>
                    <h4 class="inverted">Playing with Doctrine MongoDB ODM</h4>
                  </section>
                  <section>
                      <pre style="margin-top:-50px">
<code class="php" style="font-size:24px;">// Documents/Measurement.php
namespace Documents;

use Doctrine\ODM\MongoDB\Mapping\Annotations as MongoDB;

/** @MongoDB\Document */
class Measurement
{
    /** @MongoDB\Id */
    private $id;

    /** @MongoDB\Int */
    private $captor1;
    /** @MongoDB\Int */
    private $captor2;
    /** @MongoDB\Date */
    private $datetime;

    public function __construct($captor1, $captor2)
    {
        $this->captor1 = $captor1;
        $this->captor2 = $captor2;
        $this->datetime = time();
    }
}
</code></pre>
                  </section>
                  <section>

                    <h2>Creating and saving a Doctrine object</h2>
                    <h4 class="inverted">Playing with Doctrine MongoDB ODM</h4>
                      <pre>
<code class="php" style="font-size:24px;">$classLoader = new ClassLoader('Documents', __DIR__);
$classLoader->register();

$measurement = new \Documents\Measurement(981, 954);
$dm->persist($measurement);
$dm->flush();

var_dump($measurement);
</code></pre>
                  </section>
                </section>


            </div>

            <!-- The navigational controls UI -->
            <aside class="controls">
                <a class="left" href="#">&#x25C4;</a>
                <a class="right" href="#">&#x25BA;</a>
                <a class="up" href="#">&#x25B2;</a>
                <a class="down" href="#">&#x25BC;</a>
            </aside>

            <!-- Displays presentation progress, max value changes via JS to reflect # of slides -->
            <div class="progress"><span></span></div>

        </div>

        <script src="js/reveal.js"></script>
        <script src="lib/highlight.js"></script>
        <script>
            // Parse the query string into a key/value object
            var query = {};
            location.search.replace( /[A-Z0-9]+?=(\w*)/gi, function(a) {
                query[ a.split( '=' ).shift() ] = a.split( '=' ).pop();
            } );

            Reveal.initialize({
                // Display controls in the bottom right corner
                controls: false,

                // Display a presentation progress bar
                progress: true,

                // If true; each slide will be pushed to the browser history
                history: true,

                // Flags if mouse wheel navigation should be enabled
                mouseWheel: true,

                // Apply a 3D roll to links on hover
                rollingLinks: false,

                // UI style
                theme: query.theme || 'default', // default/neon

                // Transition style
                transition: query.transition || 'default' // default/cube/page/concave/linear(2d)
            });

            hljs.initHighlightingOnLoad();
        </script>

    </body>
</html>
